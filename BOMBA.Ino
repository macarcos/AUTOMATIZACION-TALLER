// ARDUINO BOMBA - Sistema Riego v2.2 SUPER CORREGIDO
// CORRECCIONES: Estado inicial OFF, botÃ³n emergencia funcional, control correcto
// Pin 7 = IN1 del relay, Pin 3 = botÃ³n emergencia

// ===== CONFIGURACIÃ“N DE PINES =====
#define RELAY_PIN 7        // Pin IN1 del relay para la bomba
#define BOTON_EMERGENCIA 3 // BotÃ³n fÃ­sico para EMERGENCIA (solo apagar)
#define BUZZER_PIN 11      // Buzzer para confirmaciÃ³n

// ===== CONFIGURACIÃ“N RELAY =====
// ConfiguraciÃ³n para relay tÃ­pico (activo en LOW)
const bool RELAY_ACTIVE_HIGH = false;

// ===== VARIABLES DE CONTROL =====
bool bombaActiva = false;           // Estado de la bomba
bool botonAnterior = HIGH;          // Estado anterior del botÃ³n
unsigned long ultimoDebounce = 0;   // Control debounce
const unsigned long DEBOUNCE_DELAY = 50; // 50ms debounce

// Control de tiempos
unsigned long tiempoInicioBomba = 0;
const unsigned long TIEMPO_MAXIMO = 300000; // 5 minutos mÃ¡ximo
unsigned long ultimoEnvioEstado = 0;

// EstadÃ­sticas
int vecesActivada = 0;
int vecesEmergencia = 0;
unsigned long tiempoTotalFuncionamiento = 0;

void setup() {
    Serial.begin(9600);
    
    // Configurar pines
    pinMode(RELAY_PIN, OUTPUT);
    pinMode(BOTON_EMERGENCIA, INPUT_PULLUP);  // Con resistencia pull-up interna
    pinMode(BUZZER_PIN, OUTPUT);
    
    // CRÃTICO: ESTADO INICIAL SEGURO - BOMBA SIEMPRE OFF
    forzarBombaOFF();
    bombaActiva = false;
    
    Serial.println(F("â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"));
    Serial.println(F("â•‘  ARDUINO BOMBA v2.2 CORREGIDO   â•‘"));
    Serial.println(F("â•‘    INICIO SEGURO - BOMBA OFF     â•‘"));
    Serial.println(F("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"));
    Serial.println();
    
    // Test inicial del sistema
    testInicial();
    
    Serial.println(F("âœ… Sistema listo"));
    Serial.println(F("ğŸ“± Comandos disponibles:"));
    Serial.println(F("   ON  / PUMP_ON    - Encender bomba"));
    Serial.println(F("   OFF / PUMP_OFF   - Apagar bomba"));
    Serial.println(F("   STATUS           - Ver estado"));
    Serial.println(F("   TEST             - Probar relay"));
    Serial.println(F("ğŸš¨ BotÃ³n emergencia: Pin 3 (SOLO APAGAR)"));
    Serial.println(F("ğŸ’¡ Pin relay IN1: Pin 7"));
    Serial.println(F("====================================="));
    
    // ConfirmaciÃ³n sonora - 1 beep = listo
    beep(1);
    
    mostrarStatus();
}

void loop() {
    // 1. ALTA PRIORIDAD: Monitorear botÃ³n de emergencia
    verificarBotonEmergencia();
    
    // 2. Verificar tiempo mÃ¡ximo de funcionamiento
    verificarTiempoMaximo();
    
    // 3. Procesar comandos serie
    if (Serial.available()) {
        procesarComando();
    }
    
    // 4. Enviar estado cada 5 segundos
    if (millis() - ultimoEnvioEstado >= 5000) {
        enviarEstado();
        ultimoEnvioEstado = millis();
    }
    
    delay(10); // Reducido para respuesta rÃ¡pida del botÃ³n
}

// ===== FUNCIÃ“N CRÃTICA: FORZAR BOMBA OFF =====
void forzarBombaOFF() {
    if (RELAY_ACTIVE_HIGH) {
        digitalWrite(RELAY_PIN, LOW);   // OFF para relay normal
    } else {
        digitalWrite(RELAY_PIN, HIGH);  // OFF para relay invertido
    }
    
    Serial.println(F("ğŸ›‘ BOMBA FORZADA A OFF (seguridad)"));
    Serial.print(F("ğŸ”§ Pin IN1 ("));
    Serial.print(RELAY_PIN);
    Serial.print(F("): "));
    Serial.println(digitalRead(RELAY_PIN) ? F("HIGH") : F("LOW"));
}

// ===== BOTÃ“N DE EMERGENCIA MEJORADO =====
void verificarBotonEmergencia() {
    bool estadoActual = digitalRead(BOTON_EMERGENCIA);
    
    // Detectar cambio de estado del botÃ³n
    if (estadoActual != botonAnterior) {
        ultimoDebounce = millis();
    }
    
    // Verificar que haya pasado el tiempo de debounce
    if ((millis() - ultimoDebounce) > DEBOUNCE_DELAY) {
        // Detectar presiÃ³n del botÃ³n (flanco descendente)
        if (botonAnterior == HIGH && estadoActual == LOW) {
            // EMERGENCIA: Solo puede APAGAR la bomba
            if (bombaActiva) {
                Serial.println(F("ğŸš¨ Â¡BOTÃ“N EMERGENCIA PRESIONADO!"));
                Serial.println(F("ğŸ›‘ APAGANDO BOMBA INMEDIATAMENTE"));
                
                apagarBomba();
                vecesEmergencia++;
                
                // Alarma de emergencia (3 beeps rÃ¡pidos)
                beep(3);
                
                Serial.print(F("ğŸ“Š Paradas de emergencia totales: "));
                Serial.println(vecesEmergencia);
            } else {
                Serial.println(F("ğŸš¨ BotÃ³n emergencia presionado"));
                Serial.println(F("ğŸ’¡ Bomba ya estÃ¡ apagada"));
                beep(1); // Un beep de confirmaciÃ³n
            }
        }
    }
    
    botonAnterior = estadoActual;
}

// ===== FUNCIONES DE CONTROL DE BOMBA =====
void encenderBomba() {
    if (!bombaActiva) {
        bombaActiva = true;
        tiempoInicioBomba = millis();
        vecesActivada++;
        
        // Activar relay
        if (RELAY_ACTIVE_HIGH) {
            digitalWrite(RELAY_PIN, HIGH);
        } else {
            digitalWrite(RELAY_PIN, LOW);
        }
        
        Serial.println(F("âœ… BOMBA ENCENDIDA"));
        Serial.print(F("ğŸ”„ ActivaciÃ³n #"));
        Serial.println(vecesActivada);
        Serial.print(F("ğŸ”§ Relay IN1 activado: "));
        Serial.println(digitalRead(RELAY_PIN) ? F("HIGH") : F("LOW"));
        Serial.println(F("â±ï¸ Tiempo mÃ¡ximo: 5 minutos"));
        
        beep(2); // Dos beeps = encendido
    } else {
        Serial.println(F("âš ï¸ Bomba ya estÃ¡ encendida"));
    }
}

void apagarBomba() {
    if (bombaActiva) {
        // Calcular tiempo de funcionamiento
        unsigned long tiempoFuncionamiento = millis() - tiempoInicioBomba;
        tiempoTotalFuncionamiento += tiempoFuncionamiento;
        
        bombaActiva = false;
        
        // Desactivar relay
        if (RELAY_ACTIVE_HIGH) {
            digitalWrite(RELAY_PIN, LOW);
        } else {
            digitalWrite(RELAY_PIN, HIGH);
        }
        
        Serial.println(F("ğŸ›‘ BOMBA APAGADA"));
        Serial.print(F("â±ï¸ FuncionÃ³ por: "));
        Serial.print(tiempoFuncionamiento / 1000);
        Serial.println(F(" segundos"));
        Serial.print(F("ğŸ”§ Relay IN1 desactivado: "));
        Serial.println(digitalRead(RELAY_PIN) ? F("HIGH") : F("LOW"));
        
        beep(1); // Un beep = apagado
    } else {
        Serial.println(F("âš ï¸ Bomba ya estÃ¡ apagada"));
    }
}

// ===== VERIFICAR TIEMPO MÃXIMO =====
void verificarTiempoMaximo() {
    if (bombaActiva && (millis() - tiempoInicioBomba >= TIEMPO_MAXIMO)) {
        Serial.println(F("âš ï¸ PROTECCIÃ“N: Tiempo mÃ¡ximo alcanzado (5 min)"));
        Serial.println(F("ğŸ›‘ Apagando automÃ¡ticamente..."));
        
        apagarBomba();
        
        // Alarma de protecciÃ³n (5 beeps)
        beep(5);
    }
}

// ===== PROCESAR COMANDOS SERIE =====
void procesarComando() {
    String comando = Serial.readStringUntil('\n');
    comando.trim();
    comando.toUpperCase();
    
    Serial.print(F("ğŸ“¨ Comando recibido: '"));
    Serial.print(comando);
    Serial.println(F("'"));
    
    if (comando == "ON" || comando == "PUMP_ON") {
        encenderBomba();
    }
    else if (comando == "OFF" || comando == "PUMP_OFF") {
        apagarBomba();
    }
    else if (comando == "STATUS") {
        mostrarStatus();
    }
    else if (comando == "TEST") {
        testRelay();
    }
    else if (comando == "RESET") {
        // Reset estadÃ­sticas
        vecesActivada = 0;
        vecesEmergencia = 0;
        tiempoTotalFuncionamiento = 0;
        Serial.println(F("ğŸ”„ EstadÃ­sticas reseteadas"));
    }
    else if (comando.length() > 0) {
        Serial.print(F("â“ Comando desconocido: '"));
        Serial.print(comando);
        Serial.println(F("'"));
        Serial.println(F("ğŸ’¡ Comandos: ON, OFF, STATUS, TEST, RESET"));
    }
}

// ===== ENVIAR ESTADO (JSON para web app) =====
void enviarEstado() {
    Serial.print(F("{\"pump_active\":"));
    Serial.print(bombaActiva ? F("true") : F("false"));
    Serial.print(F(",\"activations\":"));
    Serial.print(vecesActivada);
    Serial.print(F(",\"emergencies\":"));
    Serial.print(vecesEmergencia);
    Serial.print(F(",\"total_time\":"));
    Serial.print(tiempoTotalFuncionamiento / 1000);
    
    if (bombaActiva) {
        Serial.print(F(",\"current_time\":"));
        Serial.print((millis() - tiempoInicioBomba) / 1000);
        Serial.print(F(",\"time_left\":"));
        Serial.print((TIEMPO_MAXIMO - (millis() - tiempoInicioBomba)) / 1000);
    }
    
    Serial.println(F("}"));
}

// ===== MOSTRAR STATUS COMPLETO =====
void mostrarStatus() {
    Serial.println(F("â•”â•â•â•â•â•â•â•â•â•â•â• ESTADO BOMBA â•â•â•â•â•â•â•â•â•â•â•â•—"));
    Serial.print(F("â•‘ Estado actual: "));
    if (bombaActiva) {
        Serial.println(F("ENCENDIDA âœ…"));
    } else {
        Serial.println(F("APAGADA âŒ"));
    }
    
    Serial.print(F("â•‘ Pin relay IN1 ("));
    Serial.print(RELAY_PIN);
    Serial.print(F("): "));
    Serial.println(digitalRead(RELAY_PIN) ? F("HIGH") : F("LOW"));
    
    Serial.print(F("â•‘ Activaciones totales: "));
    Serial.println(vecesActivada);
    
    Serial.print(F("â•‘ Paradas emergencia: "));
    Serial.println(vecesEmergencia);
    
    Serial.print(F("â•‘ Tiempo total funcionamiento: "));
    Serial.print(tiempoTotalFuncionamiento / 1000);
    Serial.println(F(" seg"));
    
    if (bombaActiva) {
        unsigned long tiempoActual = millis() - tiempoInicioBomba;
        Serial.print(F("â•‘ Tiempo funcionando: "));
        Serial.print(tiempoActual / 1000);
        Serial.println(F(" seg"));
        
        unsigned long tiempoRestante = TIEMPO_MAXIMO - tiempoActual;
        Serial.print(F("â•‘ Tiempo restante: "));
        Serial.print(tiempoRestante / 1000);
        Serial.println(F(" seg"));
    }
    
    Serial.print(F("â•‘ BotÃ³n emergencia ("));
    Serial.print(BOTON_EMERGENCIA);
    Serial.print(F("): "));
    Serial.println(digitalRead(BOTON_EMERGENCIA) ? F("NO presionado") : F("PRESIONADO"));
    
    Serial.println(F("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"));
}

// ===== TEST INICIAL DEL SISTEMA =====
void testInicial() {
    Serial.println(F("ğŸ”§ TEST INICIAL DEL SISTEMA"));
    
    // Test del relay
    Serial.println(F("1ï¸âƒ£ Probando relay..."));
    Serial.print(F("   ConfiguraciÃ³n: "));
    Serial.println(RELAY_ACTIVE_HIGH ? F("ACTIVE HIGH") : F("ACTIVE LOW"));
    Serial.print(F("   Pin IN1 inicial: "));
    Serial.println(digitalRead(RELAY_PIN) ? F("HIGH") : F("LOW"));
    
    // Test del botÃ³n
    Serial.println(F("2ï¸âƒ£ Probando botÃ³n emergencia..."));
    Serial.print(F("   Estado botÃ³n pin "));
    Serial.print(BOTON_EMERGENCIA);
    Serial.print(F(": "));
    Serial.println(digitalRead(BOTON_EMERGENCIA) ? F("HIGH (no presionado)") : F("LOW (presionado)"));
    
    // Test del buzzer
    Serial.println(F("3ï¸âƒ£ Probando buzzer..."));
    beep(1);
    
    Serial.println(F("âœ… Test inicial completado"));
    Serial.println();
}

// ===== TEST COMPLETO DEL RELAY =====
void testRelay() {
    Serial.println(F("ğŸ”§ INICIANDO PRUEBA COMPLETA DEL RELAY"));
    
    bool estadoOriginal = bombaActiva;
    
    // Si la bomba estaba encendida, avisamos que la vamos a usar para test
    if (bombaActiva) {
        Serial.println(F("âš ï¸ Bomba estÃ¡ activa - serÃ¡ incluida en el test"));
    }
    
    Serial.println(F(""));
    Serial.println(F("1ï¸âƒ£ Estado OFF (seguro)"));
    forzarBombaOFF();
    Serial.print(F("   Pin IN1: "));
    Serial.println(digitalRead(RELAY_PIN) ? F("HIGH") : F("LOW"));
    delay(2000);
    
    Serial.println(F("2ï¸âƒ£ Estado ON (3 segundos)"));
    if (RELAY_ACTIVE_HIGH) {
        digitalWrite(RELAY_PIN, HIGH);
    } else {
        digitalWrite(RELAY_PIN, LOW);
    }
    Serial.print(F("   Pin IN1: "));
    Serial.println(digitalRead(RELAY_PIN) ? F("HIGH") : F("LOW"));
    Serial.println(F("   ğŸ‘‚ Escucha el 'click' del relay"));
    Serial.println(F("   ğŸ‘€ Observa si la bomba funciona"));
    delay(3000);
    
    Serial.println(F("3ï¸âƒ£ Regresando a OFF"));
    forzarBombaOFF();
    Serial.print(F("   Pin IN1: "));
    Serial.println(digitalRead(RELAY_PIN) ? F("HIGH") : F("LOW"));
    
    // Restaurar estado original
    if (estadoOriginal) {
        Serial.println(F("ğŸ”„ Restaurando estado original..."));
        encenderBomba();
    }
    
    Serial.println(F(""));
    Serial.println(F("âœ… PRUEBA COMPLETADA"));
    Serial.println(F("ğŸ” Si no funcionÃ³:"));
    Serial.println(F("   â€¢ Verifica conexiones IN1 â†’ Pin 7"));
    Serial.println(F("   â€¢ Verifica alimentaciÃ³n del relay"));
    Serial.println(F("   â€¢ Verifica conexiones de la bomba"));
    Serial.println(F(""));
}

// ===== FUNCIÃ“N BUZZER =====
void beep(int cantidad) {
    for (int i = 0; i < cantidad; i++) {
        digitalWrite(BUZZER_PIN, HIGH);
        delay(100);
        digitalWrite(BUZZER_PIN, LOW);
        if (i < cantidad - 1) delay(150); // Pausa entre beeps
    }
}